<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Jobs - Apply</title>
    <style>
      body{font-family:Arial, Helvetica, sans-serif;max-width:900px;margin:28px auto;padding:0 16px}
      .job{border:1px solid #eee;padding:12px;border-radius:6px;margin-bottom:10px}
      .apply{display:flex;gap:10px;align-items:center}
    </style>
  </head>
  <body>
    <h1>Open Jobs</h1>
    <div id="jobs"></div>
    <script>
      async function loadJobs(){
        const res = await fetch('/api/jobs');
        const jobs = await res.json();
        const jobsEl = document.getElementById('jobs');
        jobsEl.innerHTML = '';
        for(const j of jobs){
          const salary = j.salaryMin && j.salaryMax ? `$${j.salaryMin} - $${j.salaryMax}` : j.salaryMin ? `$${j.salaryMin}+` : 'Salary not specified';
          const skills = j.skills && j.skills.length ? j.skills.join(', ') : 'Skills not specified';
          const div = document.createElement('div'); div.className='job';
          div.innerHTML = `<h3>${j.title}</h3><p><strong>${j.company || 'Company'}</strong> - ${j.location || 'Location'}</p><p>Type: ${j.type || 'Not specified'} | Salary: ${salary}</p><p>Skills: ${skills}</p><p>${j.description}</p>` +
            `<div class="apply"><form class="uploadForm" data-id="${j._id}"><input type="file" name="file" accept="application/pdf" required /><button type="submit">Apply with Resume</button></form><div class="status" id="s-${j._id}"></div></div>`;
          jobsEl.appendChild(div);
        }
        document.querySelectorAll('.uploadForm').forEach(f => {
          f.addEventListener('submit', async (e)=>{
            e.preventDefault();
            const jobId = f.dataset.id;
            const fd = new FormData(f);
            try {
              const res = await fetch(`/api/pdf/upload?jobId=${jobId}`, { method:'POST', body: fd });
              const json = await res.json();
              document.getElementById('s-'+jobId).textContent = res.ok ? 'Applied successfully! ATS Score: '+(json.atsScore?.score ?? 'Processing...') : 'Error: '+(json.error||JSON.stringify(json));
            } catch (err) {
              document.getElementById('s-'+jobId).textContent = 'Error: '+err.message;
            }
          });
        });
      }
      loadJobs();
    </script>
  </body>
</html>
